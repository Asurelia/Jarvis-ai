# üö® JARVIS AI 2025 - R√®gles d'alerte Prometheus
# Alertes intelligentes avec seuils adaptatifs

groups:
  # ü§ñ Alertes services principaux JARVIS
  - name: jarvis-services
    rules:
      # Service indisponible
      - alert: JarvisServiceDown
        expr: up{job=~"brain-api|tts-service|stt-service|gpu-stats-service"} == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Service JARVIS {{ $labels.job }} est indisponible"
          description: "Le service {{ $labels.job }} sur {{ $labels.instance }} est down depuis {{ $value }}s"
          runbook_url: "http://localhost:3001/d/jarvis-runbooks"

      # Latence √©lev√©e des services IA
      - alert: JarvisAIServiceHighLatency
        expr: rate(http_request_duration_seconds{job=~"brain-api|tts-service|stt-service"}[5m]) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Latence √©lev√©e pour {{ $labels.job }}"
          description: "{{ $labels.job }} a une latence de {{ $value }}s, au-dessus du seuil de 5s"
          current_value: "{{ $value }}s"
          threshold: "5s"

      # Taux d'erreur √©lev√©
      - alert: JarvisServiceErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'erreur √©lev√© pour {{ $labels.job }}"
          description: "{{ $labels.job }} a un taux d'erreur de {{ $value | humanizePercentage }}"

  # üß† Alertes sp√©cifiques Brain API
  - name: brain-api-alerts
    rules:
      # Temps de r√©ponse IA excessif
      - alert: BrainAPISlowAIResponse
        expr: brain_api_ai_response_time_seconds{quantile="0.95"} > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "R√©ponses IA lentes dans Brain API"
          description: "95% des r√©ponses IA prennent plus de 30s ({{ $value }}s)"

      # Connexions WebSocket excessives
      - alert: BrainAPITooManyWebSocketConnections
        expr: brain_api_websocket_connections_active > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trop de connexions WebSocket Brain API"
          description: "{{ $value }} connexions WebSocket actives (seuil: 100)"

      # √âchec d'op√©rations m√©moire
      - alert: BrainAPIMemoryOperationFailures
        expr: rate(brain_api_memory_operations_total{status="error"}[5m]) > 0.1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "√âchecs d'op√©rations m√©moire Brain API"
          description: "Taux d'√©chec des op√©rations m√©moire: {{ $value | humanizePercentage }}"

  # üó£Ô∏è Alertes TTS Service
  - name: tts-service-alerts
    rules:
      # Temps de synth√®se excessif
      - alert: TTSServiceSlowSynthesis
        expr: tts_synthesis_duration_seconds{quantile="0.95"} > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Synth√®se TTS lente"
          description: "95% des synth√®ses TTS prennent plus de 10s ({{ $value }}s)"

      # Sessions de streaming √©lev√©es
      - alert: TTSServiceHighStreamingSessions
        expr: tts_streaming_sessions_active > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trop de sessions streaming TTS"
          description: "{{ $value }} sessions streaming actives (seuil: 20)"

  # üé§ Alertes STT Service  
  - name: stt-service-alerts
    rules:
      # Temps de transcription excessif
      - alert: STTServiceSlowTranscription
        expr: stt_transcription_duration_seconds{quantile="0.95"} > 15
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Transcription STT lente"
          description: "95% des transcriptions prennent plus de 15s ({{ $value }}s)"

      # Connexions WebSocket excessives
      - alert: STTServiceTooManyWebSocketConnections
        expr: stt_websocket_active_connections > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trop de connexions WebSocket STT"
          description: "{{ $value }} connexions WebSocket actives (seuil: 50)"

  # üéÆ Alertes GPU
  - name: gpu-alerts
    rules:
      # Utilisation GPU √©lev√©e
      - alert: GPUHighUtilization
        expr: gpu_stats_gpu_utilization_percent > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Utilisation GPU √©lev√©e"
          description: "GPU {{ $labels.gpu_id }} utilisation: {{ $value }}% (seuil: 90%)"
          gpu_utilization: "{{ $value }}%"

      # Temp√©rature GPU √©lev√©e
      - alert: GPUHighTemperature
        expr: gpu_stats_gpu_temperature_celsius > 80
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Temp√©rature GPU critique"
          description: "GPU {{ $labels.gpu_id }} temp√©rature: {{ $value }}¬∞C (seuil: 80¬∞C)"
          gpu_temperature: "{{ $value }}¬∞C"

      # M√©moire GPU faible
      - alert: GPULowMemory
        expr: (gpu_stats_gpu_memory_usage_bytes / gpu_stats_gpu_memory_total_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "M√©moire GPU faible"
          description: "GPU {{ $labels.gpu_id }} m√©moire utilis√©e: {{ $value | humanizePercentage }}"

  # üñ•Ô∏è Alertes System Control
  - name: system-control-alerts
    rules:
      # Violations de s√©curit√©
      - alert: SystemControlSecurityViolation
        expr: rate(system_control_security_violations_total[5m]) > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Violation de s√©curit√© System Control"
          description: "{{ $value }} violations de s√©curit√© d√©tect√©es (type: {{ $labels.violation_type }})"

      # Rate limiting excessif
      - alert: SystemControlRateLimitExceeded
        expr: rate(system_control_rate_limit_hits_total[5m]) > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit d√©pass√© System Control"
          description: "{{ $value }} d√©passements de rate limit par seconde"

  # üíª Alertes Terminal Service
  - name: terminal-service-alerts
    rules:
      # Trop de sessions actives
      - alert: TerminalServiceTooManySessions
        expr: terminal_service_sessions_active > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trop de sessions terminal actives"
          description: "{{ $value }} sessions terminal actives (seuil: 50)"

      # Commandes qui √©chouent fr√©quemment
      - alert: TerminalServiceHighCommandFailureRate
        expr: rate(terminal_service_commands_executed_total{status="error"}[5m]) / rate(terminal_service_commands_executed_total[5m]) > 0.2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'√©chec √©lev√© des commandes terminal"
          description: "{{ $value | humanizePercentage }} des commandes √©chouent"

  # üê≥ Alertes syst√®me et infrastructure
  - name: infrastructure-alerts
    rules:
      # Utilisation CPU √©lev√©e
      - alert: HighCPUUsage
        expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Utilisation CPU √©lev√©e"
          description: "Utilisation CPU: {{ $value }}% (seuil: 80%)"

      # M√©moire faible
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Utilisation m√©moire critique"
          description: "Utilisation m√©moire: {{ $value }}% (seuil: 90%)"

      # Espace disque faible
      - alert: LowDiskSpace
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Espace disque faible"
          description: "Espace disque utilis√©: {{ $value }}% sur {{ $labels.mountpoint }}"

  # üóÑÔ∏è Alertes bases de donn√©es
  - name: database-alerts
    rules:
      # Redis down
      - alert: RedisDown
        expr: redis_up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Redis indisponible"
          description: "Redis est down depuis {{ $value }}s"

      # PostgreSQL down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL indisponible"  
          description: "PostgreSQL est down depuis {{ $value }}s"

      # Trop de connexions PostgreSQL
      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trop de connexions PostgreSQL"
          description: "{{ $value }} connexions actives (seuil: 80)"

  # üîç Alertes m√©triques personnalis√©es
  - name: custom-business-alerts
    rules:
      # Pas de conversations depuis longtemps
      - alert: NoConversationsRecently
        expr: rate(brain_api_conversations_started_total[1h]) == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Aucune conversation JARVIS r√©cente"
          description: "Aucune nouvelle conversation depuis 30 minutes"

      # √âchec de synth√®se vocale fr√©quent
      - alert: FrequentTTSFailures
        expr: rate(tts_service_errors_total{error_type="synthesis"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "√âchecs de synth√®se TTS fr√©quents"
          description: "{{ $value }} √©checs de synth√®se TTS par seconde"

      # Performance globale d√©grad√©e
      - alert: JarvisOverallPerformanceDegraded
        expr: |
          (
            rate(brain_api_ai_response_time_seconds[5m]) > 10 or
            rate(tts_synthesis_duration_seconds[5m]) > 5 or  
            rate(stt_transcription_duration_seconds[5m]) > 3
          )
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Performance globale JARVIS d√©grad√©e"
          description: "Un ou plusieurs services JARVIS montrent des performances d√©grad√©es"