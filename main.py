#!/usr/bin/env python3
"""
ü§ñ JARVIS - Agent IA Autonome pour Windows
Script principal de d√©monstration et test

Usage:
    python main.py                    # Mode interactif
    python main.py --demo            # Mode d√©monstration
    python main.py --test            # Tests des modules
    python main.py --command "..."   # Commande directe
"""
import asyncio
import argparse
import sys
import time
from pathlib import Path
from typing import Dict, Any
import json
from loguru import logger

# Ajouter le r√©pertoire racine au path
sys.path.insert(0, str(Path(__file__).parent))

# Imports des modules JARVIS
from core.agent import JarvisAgent, create_agent
from core.vision.screen_capture import ScreenCapture, quick_screenshot
from core.vision.ocr_engine import OCREngine, quick_ocr
from core.vision.visual_analysis import VisualAnalyzer, quick_screen_analysis
from core.control.mouse_controller import MouseController, quick_click
from core.control.keyboard_controller import KeyboardController, quick_type
from core.control.app_detector import AppDetector, get_current_app
from core.ai.ollama_service import OllamaService, quick_chat
from core.ai.action_planner import ActionPlanner, quick_plan
from config.amd_gpu import configure_amd_gpu, OLLAMA_CONFIG

class JarvisDemo:
    """Classe de d√©monstration de JARVIS"""
    
    def __init__(self):
        self.modules = {}
        self.agent = None
        
    async def initialize_all_modules(self):
        """Initialise tous les modules JARVIS"""
        logger.info("üöÄ Initialisation compl√®te de JARVIS...")
        
        try:
            # Configuration GPU AMD
            configure_amd_gpu()
            
            # Vision
            logger.info("üì∏ Initialisation des modules de vision...")
            self.modules['screen_capture'] = ScreenCapture()
            await self.modules['screen_capture'].initialize()
            
            self.modules['ocr'] = OCREngine()
            await self.modules['ocr'].initialize()
            
            self.modules['vision_analyzer'] = VisualAnalyzer()
            await self.modules['vision_analyzer'].initialize()
            
            # Contr√¥le
            logger.info("üéÆ Initialisation des modules de contr√¥le...")
            self.modules['mouse'] = MouseController(sandbox_mode=True)
            await self.modules['mouse'].initialize()
            
            self.modules['keyboard'] = KeyboardController(sandbox_mode=True)
            await self.modules['keyboard'].initialize()
            
            self.modules['app_detector'] = AppDetector()
            await self.modules['app_detector'].initialize()
            
            # IA
            logger.info("ü§ñ Initialisation des modules IA...")
            self.modules['ollama'] = OllamaService()
            await self.modules['ollama'].initialize()
            
            self.modules['planner'] = ActionPlanner(self.modules['ollama'])
            
            # Agent principal
            logger.info("üéØ Cr√©ation de l'agent JARVIS...")
            self.agent = await create_agent()
            
            logger.success("‚úÖ JARVIS compl√®tement initialis√© et pr√™t!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Erreur lors de l'initialisation: {e}")
            return False
    
    async def run_basic_tests(self):
        """Ex√©cute les tests de base de tous les modules"""
        logger.info("üß™ Lancement des tests de base...")
        
        results = {}
        
        # Test capture d'√©cran
        try:
            logger.info("üì∏ Test capture d'√©cran...")
            screenshot = await self.modules['screen_capture'].capture()
            if screenshot:
                logger.success("‚úÖ Capture d'√©cran OK")
                results['screenshot'] = True
                
                # Sauvegarder pour inspection
                screenshot.save("test_screenshot.png")
                logger.info("üíæ Capture sauv√©e: test_screenshot.png")
            else:
                raise Exception("Capture √©chou√©e")
        except Exception as e:
            logger.error(f"‚ùå Test capture d'√©cran √©chou√©: {e}")
            results['screenshot'] = False
        
        # Test OCR
        try:
            logger.info("üîç Test OCR...")
            if results.get('screenshot') and 'screen_capture' in self.modules:
                screenshot = await self.modules['screen_capture'].capture()
                if screenshot:
                    ocr_result = await self.modules['ocr'].extract_text(screenshot.image, "auto")
                    if ocr_result.all_text:
                        logger.success(f"‚úÖ OCR OK - {len(ocr_result.words)} mots d√©tect√©s")
                        logger.info(f"üìù Texte √©chantillon: {ocr_result.all_text[:100]}...")
                        results['ocr'] = True
                    else:
                        logger.warning("‚ö†Ô∏è  OCR OK mais aucun texte d√©tect√©")
                        results['ocr'] = True
        except Exception as e:
            logger.error(f"‚ùå Test OCR √©chou√©: {e}")
            results['ocr'] = False
        
        # Test analyse visuelle
        try:
            logger.info("üëÅÔ∏è  Test analyse visuelle...")
            if results.get('screenshot') and 'screen_capture' in self.modules:
                screenshot = await self.modules['screen_capture'].capture()
                if screenshot:
                    analysis = await self.modules['vision_analyzer'].analyze_screen(screenshot.image)
                    logger.success(f"‚úÖ Analyse visuelle OK - {len(analysis.ui_elements)} √©l√©ments d√©tect√©s")
                    logger.info(f"üìã Description: {analysis.description[:100]}...")
                    results['visual_analysis'] = True
        except Exception as e:
            logger.error(f"‚ùå Test analyse visuelle √©chou√©: {e}")
            results['visual_analysis'] = False
        
        # Test d√©tection d'applications
        try:
            logger.info("üîç Test d√©tection d'applications...")
            apps = await self.modules['app_detector'].get_running_applications()
            if apps:
                logger.success(f"‚úÖ D√©tection apps OK - {len(apps)} applications trouv√©es")
                
                # Afficher les top 5
                for i, app in enumerate(apps[:5]):
                    status = "üü¢" if app.is_active else "‚ö™"
                    logger.info(f"  {status} {app.name} ({app.memory_usage}MB)")
                
                results['app_detection'] = True
            else:
                raise Exception("Aucune application d√©tect√©e")
        except Exception as e:
            logger.error(f"‚ùå Test d√©tection apps √©chou√©: {e}")
            results['app_detection'] = False
        
        # Test Ollama (si disponible)
        try:
            logger.info("ü§ñ Test Ollama...")
            if self.modules['ollama'].is_available:
                response = await self.modules['ollama'].chat("Bonjour JARVIS, r√©ponds juste 'OK' pour le test")
                if response.success:
                    logger.success(f"‚úÖ Ollama OK - R√©ponse: {response.content[:50]}...")
                    results['ollama'] = True
                else:
                    raise Exception(f"Erreur r√©ponse: {response.error}")
            else:
                logger.warning("‚ö†Ô∏è  Ollama non disponible")
                results['ollama'] = False
        except Exception as e:
            logger.error(f"‚ùå Test Ollama √©chou√©: {e}")
            results['ollama'] = False
        
        # Test planification
        try:
            logger.info("üìã Test planification...")
            sequence = await self.modules['planner'].parse_natural_command("Take a screenshot")
            if sequence and sequence.actions:
                logger.success(f"‚úÖ Planification OK - {len(sequence.actions)} actions planifi√©es")
                for i, action in enumerate(sequence.actions):
                    logger.info(f"  {i+1}. {action.type.value}: {action.description}")
                results['planning'] = True
            else:
                raise Exception("Aucune action planifi√©e")
        except Exception as e:
            logger.error(f"‚ùå Test planification √©chou√©: {e}")
            results['planning'] = False
        
        # R√©sum√© des tests
        logger.info("\nüìä R√âSUM√â DES TESTS:")
        total_tests = len(results)
        passed_tests = sum(1 for result in results.values() if result)
        
        for test_name, result in results.items():
            status = "‚úÖ PASS" if result else "‚ùå FAIL"
            logger.info(f"  {test_name}: {status}")
        
        logger.info(f"\nüéØ Score: {passed_tests}/{total_tests} tests r√©ussis ({passed_tests/total_tests*100:.1f}%)")
        
        return results
    
    async def run_demo_sequence(self):
        """Ex√©cute une s√©quence de d√©monstration"""
        logger.info("üé¨ Lancement de la d√©monstration JARVIS...")
        
        try:
            # 1. Capture et analyse de l'√©cran actuel
            logger.info("üì∏ 1. Capture et analyse de l'√©cran...")
            screenshot = await self.modules['screen_capture'].capture()
            if screenshot:
                analysis = await self.modules['vision_analyzer'].analyze_screen(screenshot.image)
                logger.info(f"üìã Analyse: {analysis.description[:200]}...")
                
                # OCR du texte visible
                ocr_result = await self.modules['ocr'].extract_text(screenshot.image)
                logger.info(f"üìù Texte d√©tect√©: {len(ocr_result.words)} mots")
            
            # 2. D√©tection des applications actives
            logger.info("üîç 2. D√©tection des applications...")
            active_app = await self.modules['app_detector'].get_active_application()
            if active_app:
                logger.info(f"üì± Application active: {active_app.name}")
                if active_app.main_window:
                    logger.info(f"ü™ü Fen√™tre: {active_app.main_window.title}")
            
            # 3. Planification d'une t√¢che simple
            logger.info("üìã 3. Planification d'une t√¢che...")
            sequence = await self.modules['planner'].parse_natural_command(
                "Analyze the current screen and describe what I can do"
            )
            
            logger.info(f"üìù S√©quence planifi√©e: {sequence.name}")
            for i, action in enumerate(sequence.actions[:3]):  # Montrer les 3 premi√®res
                logger.info(f"  {i+1}. {action.type.value}: {action.description}")
            
            # 4. Test d'interaction IA (si disponible)
            if self.modules['ollama'].is_available:
                logger.info("ü§ñ 4. Interaction avec l'IA...")
                
                # Analyser l'√©cran avec l'IA
                if screenshot:
                    import base64
                    import io
                    
                    # Convertir l'image en base64
                    buffer = io.BytesIO()
                    screenshot.image.save(buffer, format='PNG')
                    image_b64 = base64.b64encode(buffer.getvalue()).decode()
                    
                    ai_analysis = await self.modules['ollama'].analyze_screen(
                        image_b64, 
                        "D√©cris ce que tu vois et sugg√®re des actions possibles"
                    )
                    
                    if ai_analysis.success:
                        logger.info(f"üß† Analyse IA: {ai_analysis.content[:300]}...")
            
            logger.success("‚úÖ D√©monstration termin√©e avec succ√®s!")
            
        except Exception as e:
            logger.error(f"‚ùå Erreur pendant la d√©monstration: {e}")
    
    async def interactive_mode(self):
        """Mode interactif avec l'utilisateur"""
        logger.info("üéÆ Mode interactif JARVIS activ√©")
        logger.info("Tapez 'help' pour voir les commandes disponibles, 'quit' pour quitter")
        
        while True:
            try:
                # Prompt utilisateur
                command = input("\nü§ñ JARVIS> ").strip()
                
                if not command:
                    continue
                
                if command.lower() in ['quit', 'exit', 'q']:
                    logger.info("üëã Au revoir!")
                    break
                
                elif command.lower() == 'help':
                    self._show_help()
                
                elif command.lower() == 'status':
                    await self._show_status()
                
                elif command.lower() == 'screenshot':
                    await self._take_screenshot()
                
                elif command.lower() == 'analyze':
                    await self._analyze_current_screen()
                
                elif command.lower() == 'apps':
                    await self._show_running_apps()
                
                elif command.startswith('chat '):
                    await self._chat_with_ai(command[5:])
                
                elif command.startswith('plan '):
                    await self._plan_command(command[5:])
                
                else:
                    # Commande g√©n√©rale - essayer de la planifier et l'ex√©cuter
                    await self._execute_natural_command(command)
                
            except KeyboardInterrupt:
                logger.info("\nüëã Arr√™t demand√© par l'utilisateur")
                break
            except Exception as e:
                logger.error(f"‚ùå Erreur: {e}")
    
    def _show_help(self):
        """Affiche l'aide"""
        help_text = """
ü§ñ COMMANDES JARVIS DISPONIBLES:

Commandes syst√®me:
  help                    - Affiche cette aide
  status                  - Statut des modules
  quit/exit/q            - Quitter JARVIS

Vision et analyse:
  screenshot             - Prendre une capture d'√©cran
  analyze                - Analyser l'√©cran actuel
  
Applications:
  apps                   - Lister les applications en cours

IA et planification:
  chat <message>         - Discuter avec JARVIS
  plan <commande>        - Planifier une commande
  
Commandes naturelles:
  Vous pouvez aussi donner des commandes en langage naturel:
  - "Take a screenshot"
  - "Open notepad"
  - "Search for Python on Google"
  - "Close the current window"
"""
        print(help_text)
    
    async def _show_status(self):
        """Affiche le statut des modules"""
        logger.info("üìä STATUT DES MODULES JARVIS:")
        
        for name, module in self.modules.items():
            status = "‚úÖ OK" if module else "‚ùå ERREUR"
            
            # Informations sp√©cifiques par module
            extra_info = ""
            
            if name == 'ollama' and module:
                extra_info = f" ({len(module.get_available_models())} mod√®les)"
            elif name == 'screen_capture' and module:
                info = module.get_screen_info()
                extra_info = f" ({len(info['monitors'])} moniteur(s))"
            elif name == 'app_detector' and module:
                stats = module.get_application_stats()
                extra_info = f" ({stats.get('total_applications', 0)} apps)"
            
            logger.info(f"  {name}: {status}{extra_info}")
    
    async def _take_screenshot(self):
        """Prend une capture d'√©cran"""
        try:
            logger.info("üì∏ Prise de capture d'√©cran...")
            screenshot = await self.modules['screen_capture'].capture()
            if screenshot:
                filename = f"jarvis_screenshot_{int(time.time())}.png"
                screenshot.save(filename)
                logger.success(f"‚úÖ Capture sauv√©e: {filename}")
            else:
                logger.error("‚ùå √âchec de la capture")
        except Exception as e:
            logger.error(f"‚ùå Erreur capture: {e}")
    
    async def _analyze_current_screen(self):
        """Analyse l'√©cran actuel"""
        try:
            logger.info("üëÅÔ∏è  Analyse de l'√©cran...")
            screenshot = await self.modules['screen_capture'].capture()
            if screenshot:
                analysis = await self.modules['vision_analyzer'].analyze_screen(screenshot.image)
                
                logger.info(f"üìã Type de sc√®ne: {analysis.scene_type}")
                logger.info(f"üìù Description: {analysis.description}")
                logger.info(f"üî≤ √âl√©ments d√©tect√©s: {len(analysis.ui_elements)}")
                
                if analysis.actions_suggested:
                    logger.info("üí° Actions sugg√©r√©es:")
                    for action in analysis.actions_suggested[:3]:
                        logger.info(f"  - {action}")
            else:
                logger.error("‚ùå Impossible de capturer l'√©cran")
        except Exception as e:
            logger.error(f"‚ùå Erreur analyse: {e}")
    
    async def _show_running_apps(self):
        """Affiche les applications en cours"""
        try:
            logger.info("üîç Applications en cours d'ex√©cution:")
            apps = await self.modules['app_detector'].get_running_applications()
            
            for i, app in enumerate(apps[:10]):  # Top 10
                status = "üü¢ ACTIVE" if app.is_active else "‚ö™"
                windows = f" ({len(app.windows)} fen√™tres)" if app.windows else ""
                logger.info(f"  {status} {app.name} - {app.memory_usage}MB{windows}")
            
            if len(apps) > 10:
                logger.info(f"  ... et {len(apps) - 10} autres applications")
                
        except Exception as e:
            logger.error(f"‚ùå Erreur listage apps: {e}")
    
    async def _chat_with_ai(self, message: str):
        """Discute avec l'IA"""
        try:
            if not self.modules['ollama'].is_available:
                logger.warning("‚ö†Ô∏è  Service Ollama non disponible")
                return
            
            logger.info(f"ü§ñ Discussion avec JARVIS: {message}")
            response = await self.modules['ollama'].chat(message)
            
            if response.success:
                logger.info(f"üí¨ JARVIS: {response.content}")
            else:
                logger.error(f"‚ùå Erreur IA: {response.error}")
        except Exception as e:
            logger.error(f"‚ùå Erreur chat: {e}")
    
    async def _plan_command(self, command: str):
        """Planifie une commande"""
        try:
            logger.info(f"üìã Planification: {command}")
            sequence = await self.modules['planner'].parse_natural_command(command)
            
            logger.info(f"üìù S√©quence: {sequence.name}")
            logger.info(f"üìÉ Description: {sequence.description}")
            logger.info(f"üî¢ Actions ({len(sequence.actions)}):")
            
            for i, action in enumerate(sequence.actions):
                logger.info(f"  {i+1}. {action.type.value}: {action.description}")
                if action.parameters:
                    logger.info(f"     Param√®tres: {action.parameters}")
        except Exception as e:
            logger.error(f"‚ùå Erreur planification: {e}")
    
    async def _execute_natural_command(self, command: str):
        """Ex√©cute une commande en langage naturel"""
        try:
            logger.info(f"üéØ Ex√©cution de la commande: {command}")
            
            # Pour l'instant, juste planifier (l'ex√©cution sera impl√©ment√©e plus tard)
            sequence = await self.modules['planner'].parse_natural_command(command)
            
            logger.info(f"üìã Commande planifi√©e: {sequence.name}")
            logger.info(f"‚ö†Ô∏è  Ex√©cution automatique pas encore impl√©ment√©e")
            logger.info("üí° Utilisez 'plan <commande>' pour voir le plan d'action")
            
        except Exception as e:
            logger.error(f"‚ùå Erreur ex√©cution: {e}")

async def main():
    """Fonction principale"""
    parser = argparse.ArgumentParser(description="JARVIS - Agent IA Autonome")
    parser.add_argument('--demo', action='store_true', help='Mode d√©monstration')
    parser.add_argument('--test', action='store_true', help='Ex√©cuter les tests')
    parser.add_argument('--command', type=str, help='Ex√©cuter une commande directe')
    parser.add_argument('--config', type=str, help='Fichier de configuration')
    
    args = parser.parse_args()
    
    # Banni√®re de d√©marrage
    print("""
    ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    
    ü§ñ Agent IA Autonome pour Windows
    Version 1.0.0 - Phase de d√©veloppement
    """)
    
    # Initialisation
    demo = JarvisDemo()
    
    if not await demo.initialize_all_modules():
        logger.error("‚ùå Impossible d'initialiser JARVIS")
        return 1
    
    # Mode choisi
    if args.test:
        await demo.run_basic_tests()
    
    elif args.demo:
        await demo.run_demo_sequence()
    
    elif args.command:
        # Ex√©cuter une commande directe
        try:
            sequence = await demo.modules['planner'].parse_natural_command(args.command)
            logger.info(f"üìã Commande planifi√©e: {sequence.name}")
            
            for i, action in enumerate(sequence.actions):
                logger.info(f"  {i+1}. {action.type.value}: {action.description}")
        except Exception as e:
            logger.error(f"‚ùå Erreur commande: {e}")
    
    else:
        # Mode interactif par d√©faut
        await demo.interactive_mode()
    
    return 0

if __name__ == "__main__":
    try:
        exit_code = asyncio.run(main())
        sys.exit(exit_code)
    except KeyboardInterrupt:
        logger.info("\nüëã JARVIS arr√™t√© par l'utilisateur")
        sys.exit(0)
    except Exception as e:
        logger.error(f"‚ùå Erreur fatale: {e}")
        sys.exit(1)