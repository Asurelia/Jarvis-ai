# üñ•Ô∏è Control Pod - JARVIS 2025
# Pod Contr√¥le ind√©pendant : System Control + Terminal + Actions

networks:
  control_network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.23.0.0/16

volumes:
  control_cache:
  terminal_sessions:

services:
  # üñ•Ô∏è System Control Service - Contr√¥le syst√®me s√©curis√©
  system-control:
    build:
      context: ./services/system-control
      dockerfile: Dockerfile
    container_name: control_pod_system
    expose:
      - "5004"
    environment:
      - SANDBOX_MODE=true
      - MAX_ACTIONS_PER_MINUTE=60
      - DISPLAY=:99
      - VOICE_BRIDGE_URL=http://host.docker.internal:3001
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_REQUIRED=true
      - ALLOWED_INTERNAL_IPS=172.23.0.0/16
    volumes:
      - ./logs:/app/logs
      - control_cache:/app/cache
    networks:
      control_network:
        ipv4_address: 172.23.0.10
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Security hardening - removed dangerous privileges
    privileged: false
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    # Communication avec host
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # üíª Terminal Service - Sessions terminal intelligentes
  terminal-service:
    build:
      context: ./services/terminal-service
      dockerfile: Dockerfile
    container_name: control_pod_terminal
    expose:
      - "5005"
    environment:
      - MAX_TERMINAL_SESSIONS=10
      - SESSION_TIMEOUT_MINUTES=30
      - AI_POD_URL=http://host.docker.internal:8080
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_REQUIRED=true
      - ALLOWED_INTERNAL_IPS=172.23.0.0/16
    volumes:
      - ./logs:/app/logs
      - terminal_sessions:/app/sessions
    networks:
      control_network:
        ipv4_address: 172.23.0.20
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Communication avec host et autres pods
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ü§ñ Action Executor - Ex√©cuteur d'actions avanc√©es
  action-executor:
    build:
      context: ./services/action-executor
      dockerfile: Dockerfile
    container_name: control_pod_executor
    expose:
      - "5021"
    environment:
      - SYSTEM_CONTROL_URL=http://system-control:5004
      - TERMINAL_SERVICE_URL=http://terminal-service:5005
      - AI_POD_URL=http://host.docker.internal:8080
      - VOICE_BRIDGE_URL=http://host.docker.internal:3001
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_REQUIRED=true
      - ALLOWED_INTERNAL_IPS=172.23.0.0/16
    networks:
      control_network:
        ipv4_address: 172.23.0.30
    depends_on:
      - system-control
      - terminal-service
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5021/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Communication inter-pods
    extra_hosts:
      - "host.docker.internal:host-gateway"